<body id=b style=margin:0>
<canvas id=a></canvas>
<script>
d = document;
c = a.getContext("2d");
a.width = innerWidth;
a.height = innerHeight;

con = console;

sw = innerWidth;
sh = innerHeight;
objs = 250; // no of objects
fric = .99;
v = [];

ran = (min, max) => min + Math.random() * (max - min);
abs = i => Math.abs(i)

create = _ => {
	coin = ~~ran(3,6)
	f = .5
	v.push({
		mx: ran(-f,f),
		my: ran(-f,f),
		mmx: 0,
		mmy: 0,
		r: coin ** 2,
		x: ran(0, sw),
		y: ran(0, sh / 2),
		colour: ["#90a","#f32","#138"][coin-3]
	})
}

for (i = 0; i++ < objs;) {
	create()
}

p = {x: -100, y: sh - 60, r: 40}; //pacman

render = t => {
	requestAnimationFrame(render);
	c.clearRect(0,0,sw,sh)

	if (v.length < objs && ran(0,1) > .9) create();

	con.log(v.length)
	p.x += 5;
	if (p.x > sw + p.r) {
		p.r = ran(3,15) ** 2
		p.y = sh - p.r
		p.x = -p.r
	}


	distance = (b,o) => {
		dx = b.x - o.x;
		dy = b.y - o.y;
		d = Math.sqrt( dx * dx + dy * dy ) + 1/1e5;
		return {dx,dy,d}
	}

	v = v.filter((b,i)=>{
	  	v.slice(i).map((o,j)=>{
	  //for(j=i+1;j++<objs;){o=v[j] // for loop is 2 chrs more than slice&map
	  		var {dx,dy,d} = distance(b, o);
			r = b.r + o.r;
			if (d < r) { // bounce time
				m = r / d * 10;
				ux = m * dx / d;
				uy = m * dy / d;

				b.mx += ux / b.r;
				b.my += uy / b.r;

				o.mx -= ux / o.r;
				o.my -= uy / o.r;
			}

		});

		b.mx *= fric;
		b.my += .1; // gravity
		b.my *= fric;

		c.fillStyle = b.colour;
		c.beginPath();
		c.arc(b.x, b.y, b.r, 0, Math.PI * 2, false);
		c.fill();
		return !(distance(b, p).d < b.r + p.r);
	});

	v.map(b => {
		if ( b.x < b.r ) b.mx = abs(b.mx);
		if ( b.x > sw - b.r ) b.mx = -abs(b.mx);
		if ( b.y > sh - b.r ) b.my = -abs(b.my); // bouncey coins
		b.mmx -= (b.mmx - b.mx) * .7;
		b.mmy -= (b.mmy - b.my) * .7;
		b.x += b.mmx;
		b.y += b.mmy;
	});

	ang = Math.sin(t*.01)

	c.fillStyle = "yellow";
	c.beginPath();
	c.arc(p.x, p.y, p.r, ang, Math.PI * 2 - ang, false);
	c.lineTo(p.x, p.y)
	c.fill();


}
render();

</script>
